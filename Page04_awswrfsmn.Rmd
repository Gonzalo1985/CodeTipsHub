---
title: Relative humidity calibration
layout: post
subtitle: Gonzalo M. DÃ­az
leafletmap: true
always_allow_html: yes
last_modified_at: 2024-12-04
output: 
  md_document:
    variant: gfm
    preserve_yaml: true
---

Post for calibration of relative humidity of WRF model

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data download

First, the aws.wrfsmn and others libraries should be open:
```{r}
library("aws.wrfsmn")
library("dplyr")
library("terra")
```

Then, some WRF filenames are defined from WRF SMN AWS service
```{r}
filenames <- c()
for (i in 1:2)
  {aux.filenames <- get.wrf.files(year = 2023, month = 1, day = i, cycle = 12, time = "01H")
   filenames <- c(filenames, aux.filenames)
  }
print(filenames[1:13])
```

The data of WRF model is downloaded from AWS (<https://registry.opendata.aws/smn-ar-wrf-dataset/>). The documentation of this dataset can be obtained from: <https://odp-aws-smn.github.io/documentation_wrf_det/>.

Finally the dataset is downloaded from the 'filenames' variable:
```{r, eval = FALSE}
wrf.download(wrf.name = filenames)
```

After this line, the dataset defined in 'filenames' will be downloaded.

## Definition of predictors variables

The variables for the adjustment can be any of those found in the WRF dataset. Here would be:
```{r}
variables <- rast("WRFDETAR_01H_20230101_12_000.nc") %>% names()
print(variables)
```

The definition of each variable can be obtained from: <https://odp-aws-smn.github.io/documentation_wrf_det/Formato_de_datos/>

<!-- There is no limit on which variables to take, they could be more or less depending on what the user wants. -->

<!-- ## Definition of parameters of the Multiple Linear Regression -->

<!-- The data now will be trained with the 2015-01-01 to 2016-12-31 period using 'multiple.guidance' function with the *predictors.variables* vector: -->

<!-- ```{r} -->
<!-- data <- eva -->
<!-- data.training <- data[1:which(data$Dates == "2016-12-31"),] -->

<!-- ml.model <- multiple.guidance(input.data = data.training, -->
<!--                               predictand = 'evapo_obs', -->
<!--                               predictors = predictors.variables) -->
<!-- ml.model$coefficients -->
<!-- ``` -->

<!-- Now, the parameters can be used to evaluate the model in any dataset. Here it is applied to the same training period: -->
<!-- ```{r} -->
<!-- train.eval <- mg.evaluation(input.data = data.training, predictand = 'evapo_obs', -->
<!--                             predictors = predictors.variables, -->
<!--                             var.model = 'OUT_EVAP', -->
<!--                             lmodel = ml.model) -->
<!-- ``` -->

<!-- The second element of the list has the statistics parameters of the calibration: -->
<!-- ```{r} -->
<!-- train.eval[[2]] -->
<!-- ``` -->

<!-- And the plot can be visualize with 'ploting' function, but first the monthly data is calculated (for better visualization) with 'daily2monthly' function: -->
<!-- ```{r} -->
<!-- ploting(daily2monthly(data = train.eval[[1]])) -->
<!-- ``` -->

<!-- ## Calibration of evaporation soil model output for a verification dataset -->

<!-- The parameters of the previous section now are applied to the data.verification period. This period will be defined from 2017-01-01 to 2017-12-31. Then, the statistics parameters of the calibration in this dataset are shown: -->
<!-- ```{r} -->
<!-- data.verification <- data[which(data$Dates == "2017-01-01"):which(data$Dates == "2017-12-31"),] -->

<!-- verif.eval <- mg.evaluation(input.data = data.verification, predictand = 'evapo_obs', -->
<!--                             predictors = predictors.variables, -->
<!--                             var.model = 'OUT_EVAP', -->
<!--                             lmodel = ml.model) -->

<!-- verif.eval[[2]] -->
<!-- ``` -->

<!-- Finally, the monthly plot of this dataset is displayed below: -->
<!-- ```{r} -->
<!-- ploting(daily2monthly(data = verif.eval[[1]])) -->
<!-- ``` -->